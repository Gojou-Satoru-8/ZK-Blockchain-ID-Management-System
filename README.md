# Basic Setup

## System Setup

1. Install `nvm`
2. Install the latest LTS version of node using `nvm install --lts` (This project was made using node version 22)
3. Install cargo `curl https://sh.rustup.rs -sSf | sh` then run `source $HOME/.cargo/env`
4. Now run `git clone https://github.com/iden3/circom.git && cd circom`
5. Run `cargo build --release` && `cargo install --path circom`

## Project Setup and Deployment

1. Move into the project directory, and run `npm install`
2. Set executable permission for the `./scripts/compile-script.sh`, via `chmod 754 ./scripts/compile-script.sh`
3. Compile circuit using:

   1. `npm run compilecircuit` or
   2. Running `scripts/compile-circuit.sh` script directly (via `./scripts/compile-circuit.sh`).
   <!-- 3. Here we can modify the script to select the Ptau file if the compilation of the circuit has to many constraits. -->

4. (Optional) Run bump solidity script using `npm run bumpsolidityverifier`.
5. Setup a network locally using `npm run hardhat:node` or `npx hardhat node --verbose`
6. Now you have to deploy the contracts, use `npm run deploy` or `npx hardhat run --network localhost scripts/deploy.ts` to deploy it in the hardhat local network setup in the earlier step.
   Or in case you want to deploy into sepolia testnet, use `npm run deploysepolia` or `hardhat run --network sepolia scripts/deploy.ts`.
7. Copy the contract address from the console output of deploy, and assign it to the CREDENTIALS_DB_ADDRESS field in the .env file
8. Finally, run the Next.js app using `npm run dev`
9. Before connecting an account, you must ensure you are logged into Metamask and connected to localhost.

## Localhost configuration for Metamask Extension (Browser)

1. Add custom network with following values:
   1. RPC URL: `http://127.0.0.1:8545`
   2. Chain ID: `31337`
   3. Currency symbol: `ETH`
   4. Now select the new network (Localhost).
2. Now add accounts from the console output of the hardhat local network to Metamask.
   1. Click the account dropdown, and select `Add account or hardware wallet`.
   2. Under `Import a wallet or account`, select `Private Key` option.
   3. Paste the private key of the accounts from the console output of the hardhat local network.
   4. Now select `Import` button.
   5. NOTE: You need the first account of the console output to be able to issue credentials, as that is the owner of the contract.

## System Players

- Issuer: it is the account which owns the contract and can issue new credentials.
- User proover: A user that holds a specific credential and can generate a proof of that possession.
- User verifier: A user that verifies the proof.

### Application overview

The application consists of a front-end built using Next.js, and two contracts that have to be deployed in an EVM blockchain. Tools like circom, snarkjs and zk-kit have been used to implement zk mechanics.

The first contract is CredentialsDB.sol, this contract contains a register with encrypted credentials and a Merkle Tree. The register is used to guarantee the credential availability to the users since all credentials are public accesible. Nevertheless, they are encrypted with users public key. The Merkle Tree is used to hold leaves that represents credentials.

The second contract is a verifier that is autogenerated using snarkjs library. The circuit from which the verifier contract is generated is circuits/zkVerifiableCredentialsDBCore.circom.

Another component of the system is the frontend app. Through the app we can interact with on chain contracts to issue new credentials if we are a issuer and to proof and validate credentials if we are a user. The app detects if you are a issuer and shows a different menu.

### Optional Configuration

1. Modify the example credential schema credentials-src/examplecredentialschema.json. The schema is a JSON file that defines the claims of a credentials set.

2. Modify `circuits/zkVerifiableCredentialsDBCore.circom`, set "depth" and "claimsN" parameters. "depth" is the depth of the Merkle Tree, this value is related to the total credentials that can be issued (total credentials = 2^depth). If we set a deeper Merkle Tree, circom compilation will output more constraints and we will need a bigger Ptau file to build SNARK setup ([Check available Ptau files](https://github.com/iden3/snarkjs#7-prepare-phase-2)). The "clamisN" parameter has to correspond with the length of the claims array in the schema. Below an example where i set depth=16 and claimsN=5 is shown.

3. Set same TREE_DEPTH in the credentialsDB.sol.

## Resources

1. [compiling circuits](https://docs.circom.io/getting-started/compiling-circuits)
2. [Example implementation](https://medium.com/better-programming/zero-knowledge-proofs-using-snarkjs-and-circom-fac6c4d63202)
3. [Witness Generation](https://docs.circom.io/getting-started/computing-the-witness/)
